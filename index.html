<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Chat App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5e9;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }

        /* Message Box Animation */
        @keyframes bounce-in {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-bounce-in {
            animation: bounce-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <div class="flex flex-col flex-1 max-w-2xl mx-auto w-full p-4">
        <h1 class="text-3xl font-bold mb-4 text-center text-gray-700">Simple Chat App</h1>
        <div id="chat-container" class="bg-white rounded-xl shadow-lg flex flex-col flex-1 p-4 mb-4 overflow-y-auto custom-scrollbar transition-all duration-300">
            <div id="user-id-display" class="text-center mb-4">
                <span class="text-sm font-medium text-gray-500">
                    User ID: <span class="font-mono text-gray-700">Loading...</span>
                </span>
            </div>
            <div id="messages-list" class="flex flex-col space-y-4">
                <div class="text-center text-gray-500 italic">
                    Start a conversation!
                </div>
            </div>
        </div>
        <form id="chat-form" class="flex space-x-2">
            <input
                id="message-input"
                type="text"
                class="flex-1 p-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300"
                placeholder="Type your message..."
            />
            <button
                type="submit"
                id="send-button"
                class="p-3 bg-blue-500 text-white rounded-full shadow-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-300"
            >
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </form>
        <div class="text-xs text-center text-gray-400 mt-2">
            Coded by Gemini
        </div>
    </div>

    <!-- Custom Error Message Modal -->
    <div id="error-message-modal" class="fixed bottom-4 right-4 z-50 p-4 rounded-xl shadow-lg bg-red-500 text-white flex items-center space-x-2 animate-bounce-in hidden">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 8V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <p id="error-message-text" class="font-medium"></p>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        // NOTE: The Canvas environment is not providing the config automatically, so you must paste your own here.
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const API_KEY = ""; // Canvas will provide this at runtime
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 5;
        const INITIAL_DELAY = 1000; // 1 second

        let auth, db, userId = null;
        let isAuthReady = false;

        // --- UI Elements ---
        const messagesList = document.getElementById('messages-list');
        const messageInput = document.getElementById('message-input');
        const chatForm = document.getElementById('chat-form');
        const sendButton = document.getElementById('send-button');
        const userIdDisplay = document.getElementById('user-id-display').querySelector('span');
        const errorMessageModal = document.getElementById('error-message-modal');
        const errorMessageText = document.getElementById('error-message-text');

        // --- Utility Functions ---
        const showErrorMessage = (message) => {
            errorMessageText.textContent = message;
            errorMessageModal.classList.remove('hidden');
            setTimeout(() => {
                errorMessageModal.classList.add('hidden');
            }, 5000);
        };

        const scrollToBottom = () => {
            messagesList.scrollTop = messagesList.scrollHeight;
        };

        const setUIState = (loading) => {
            messageInput.disabled = loading;
            sendButton.disabled = loading;
            sendButton.innerHTML = loading ? '<span class="loader"></span>' : '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        };

        const renderMessage = (msg) => {
            const messageEl = document.createElement('div');
            messageEl.classList.add('flex', 'space-x-2', 'transition-all', 'duration-300');
            
            const msgBubbleEl = document.createElement('div');
            msgBubbleEl.classList.add('max-w-xs', 'md:max-w-md', 'lg:max-w-lg', 'p-3', 'rounded-2xl', 'shadow-md', 'transition-all', 'duration-300');
            
            if (msg.role === 'user') {
                messageEl.classList.add('justify-end');
                msgBubbleEl.classList.add('bg-blue-500', 'text-white', 'rounded-br-none');
            } else {
                messageEl.classList.add('justify-start');
                msgBubbleEl.classList.add('bg-gray-200', 'text-gray-800', 'rounded-bl-none');
            }

            msgBubbleEl.textContent = msg.text;
            messageEl.appendChild(msgBubbleEl);
            messagesList.appendChild(messageEl);
            scrollToBottom();
        };

        const callGeminiAPI = async (chatHistory, retries = 0) => {
            const payload = {
                contents: chatHistory.map(message => ({
                    role: message.role,
                    parts: [{ text: message.text }]
                }))
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries < MAX_RETRIES) {
                        const delay = INITIAL_DELAY * Math.pow(2, retries);
                        console.warn(`Rate limit exceeded. Retrying in ${delay / 1000} seconds...`);
                        await new Promise(res => setTimeout(res, delay));
                        return await callGeminiAPI(chatHistory, retries + 1);
                    }
                    throw new Error(`API response was not ok: ${response.statusText}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        };

        // --- Firebase Initialization and Auth ---
        window.onload = function () {
            if (Object.keys(firebaseConfig).length > 0) {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        isAuthReady = true;
                        setupFirestoreListener();
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            showErrorMessage("Failed to authenticate with Firebase.");
                        }
                    }
                });
            } else {
                showErrorMessage("Firebase configuration is missing.");
            }
        };

        // --- Firestore Listener Setup ---
        let lastMessageCount = 0;
        const setupFirestoreListener = () => {
            if (!db || !userId || !isAuthReady) return;

            const chatCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'messages');
            const q = query(chatCollectionRef);

            onSnapshot(q, (snapshot) => {
                const msgs = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })).sort((a, b) => a.timestamp - b.timestamp);

                if (msgs.length > lastMessageCount) {
                    messagesList.innerHTML = '';
                    if (msgs.length === 0) {
                      messagesList.innerHTML = `<div class="text-center text-gray-500 italic">Start a conversation!</div>`;
                    }
                    msgs.forEach(msg => renderMessage(msg));
                }
                lastMessageCount = msgs.length;
            }, (error) => {
                console.error("Firestore onSnapshot Error:", error);
                showErrorMessage("Failed to fetch messages from Firestore.");
            });
        };

        // --- Message Sending Logic ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = messageInput.value.trim();
            if (!input || !userId) return;

            setUIState(true);
            messageInput.value = '';

            const userMessage = {
                role: 'user',
                text: input,
                timestamp: Date.now()
            };

            try {
                const userMessageRef = doc(collection(db, 'artifacts', appId, 'users', userId, 'messages'));
                await setDoc(userMessageRef, userMessage);

                // Re-fetch all messages to build chat history for API call
                const snapshot = await getDocs(collection(db, 'artifacts', appId, 'users', userId, 'messages'));
                const chatHistory = snapshot.docs.map(doc => ({ ...doc.data() })).sort((a, b) => a.timestamp - b.timestamp).map(msg => ({
                    role: msg.role === 'ai' ? 'model' : 'user',
                    text: msg.text
                }));

                const response = await callGeminiAPI(chatHistory);
                const aiResponseText = response?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiResponseText) {
                    const aiMessageRef = doc(collection(db, 'artifacts', appId, 'users', userId, 'messages'));
                    await setDoc(aiMessageRef, {
                        role: 'ai',
                        text: aiResponseText,
                        timestamp: Date.now()
                    });
                } else {
                    throw new Error("Invalid API response: No text content found.");
                }
            } catch (error) {
                console.error("AI generation failed:", error);
                showErrorMessage(`Error: ${error.message}. Please try again.`);
            } finally {
                setUIState(false);
            }
        });
    </script>
</body>
</html>
